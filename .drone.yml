pipeline:
  test_node16:
    image: node:16
    pull: true
    commands:
      - apt update
      - apt install xxd
      - node -v
      - npm -v
      - npm ci
      - npm run build
      - npm -g install .
      - npm test
    when:
      ref: [refs/tags/v*]

  test_node14:
    image: node:14
    pull: true
    commands:
      - apt update
      - apt install xxd
      - node -v
      - npm -v
      - npm ci
      - npm run build
      - npm -g install .
      - npm test
    when:
      ref: [refs/tags/v*]

  test_node12:
    image: node:12
    pull: true
    commands:
      - apt update
      - apt install xxd
      - node -v
      - npm -v
      - npm ci
      - npm run build
      - npm -g install .
      - npm test

  publish_npm_alpha:
    image: plugins/npm
    secrets: [npm_token]
    username: iexecteam
    email: dev@iex.ec
    tag: alpha
    when:
      ref: [refs/tags/v7*]

  publish_dockerhub_alpha:
    image: plugins/docker
    repo: iexechub/iexec-sdk
    secrets: [docker_username, docker_password]
    tags:
      - alpha
      - ${DRONE_TAG##v}
    when:
      ref: [refs/tags/v7*]

  # publish_npm:
  #   image: plugins/npm
  #   secrets: [npm_token]
  #   username: iexecteam
  #   email: dev@iex.ec
  #   tag: latest
  #   when:
  #     ref: [refs/tags/v7*]

  # publish_dockerhub:
  #   image: plugins/docker
  #   repo: iexechub/iexec-sdk
  #   secrets: [docker_username, docker_password]
  #   tags:
  #     - latest
  #     - ${DRONE_TAG##v}
  #   when:
  #     ref: [refs/tags/v7*]

services:
  token-chain:
    image: iexechub/poco-chaintest:5.3.0-ganache-update-token
    pull: true

  native-chain:
    image: iexechub/poco-chaintest:5.3.0-ganache-update-native
    pull: true

  token-chain-1s:
    image: iexechub/poco-chaintest:5.3.0-ganache-update-token-1s
    pull: true

  token-chain-parity:
    image: 'iexechub/poco-chaintest:5.3.0-token-parity'

  token-sms:
    image: iexechub/iexec-sms:1.0.0
    environment:
      - IEXEC_SMS_BLOCKCHAIN_NODE_ADDRESS=http://token-chain-parity:8545
      - IEXEC_HUB_ADDRESS=0xBF6B2B07e47326B7c8bfCb4A5460bef9f0Fd2002
      - IEXEC_SCONE_CAS_HOST=cas
      - SCONE_CAS_ADDR=cas:18765
      - SCONE_LAS_ADDR=las:18766
      - SCONE_CONFIG_ID=s1/iexec-sms
      - SCONE_HEAP=3G
      - SCONE_LOG=6
      - SCONE_VERSION=1
      - SCONE_SYSLIBS=1
    expose:
      - '15000'
      - '15443'
    depends_on:
      - token-chain-parity

  token-result-proxy-mongo:
    image: mongo:4-xenial

  ipfs:
    image: ipfs/go-ipfs:v0.4.20
    container_name: ipfs

  token-result-proxy:
    image: iexechub/iexec-result-proxy:1.0.0
    environment:
      - IEXEC_PRIVATE_CHAIN_ADDRESS=http://token-chain-parity:8545
      - IEXEC_PUBLIC_CHAIN_ADDRESS=http://token-chain-parity:8545
      - MONGO_HOST=token-result-proxy-mongo
      - MONGO_PORT=27017
      - IEXEC_IPFS_HOST=ipfs
    expose:
      - '18089'
    depends_on:
      - token-chain-parity
      - token-result-proxy-mongo
      - ipfs

  gateway-mongo:
    image: mongo:latest

  gateway-redis:
    image: redis:alpine
    command: redis-server --appendonly yes

  token-watcher:
    image: iexechub/iexec-market-watcher:next
    environment:
      - DEBUG=iexec-watcher*
      - DEBUG_COLORS=true
      - CHAIN=DEV
      - CHAIN_ID=65535
      - IEXEC_ADDRESS=0xC129e7917b7c7DeDfAa5Fff1FB18d5D7050fE8ca
      - ETH_WS_HOST=ws://token-chain-parity:8546
      - ETH_RPC_HOST=http://token-chain-parity:8545
      - MONGO_HOST=gateway-mongo
      - REDIS_HOST=gateway-redis
    depends_on:
      - token-chain-parity
      - gateway-redis
      - gateway-mongo

  token-gateway:
    image: iexechub/iexec-market-api:next
    expose:
      - '3000'
    environment:
      - DEBUG=iexec-market-api*
      - DEBUG_COLORS=true
      - CHAINS=DEV
      - DEV_NATIVE=false
      - DEV_ETH_RPC_HOST=http://token-chain-parity:8545
      - DEV_CHAIN_ID=65535
      - DEV_IEXEC_ADDRESS=0xC129e7917b7c7DeDfAa5Fff1FB18d5D7050fE8ca
      - MONGO_HOST=gateway-mongo
      - REDIS_HOST=gateway-redis
      - RATE_LIMIT_MAX=10000
      - RATE_LIMIT_PERIOD=60000
      - MAX_OPEN_ORDERS_PER_WALLET=1000
    depends_on:
      - token-chain-parity
      - gateway-redis
      - gateway-mongo
